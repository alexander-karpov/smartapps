from functools import lru_cache
from dialoger import Dialog, TextReply, Voice, DialogAPI
from enrichment import add_random_adjective, random_hypernym
from morphy import by_gender, inflect_deprecated
from stories.story import Story, StoryStep


class AtLessonStory(Story):
    """
    –ù–∞ –ø–∞—Ä–µ –≥–µ–æ–≥—Ä–∞—Ñ–∏–∏ —É—á–∏—Ç–µ–ª—å–Ω–∏—Ü–∞ —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç:
    - –†–µ–±—è—Ç–∞, –∫–∞–∫ –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è –±–æ–ª—å—à–∞—è –ø—É—Å—Ç—ã–Ω—è –≤ –ê—Ñ—Ä–∏–∫–µ?
    - –°–∞—Ö–∞—Ä–∞! - –æ—Ç–≤–µ—á–∞–µ—Ç –æ–¥–∏–Ω –º–∞–ª—å—á–∏–∫.
    - –û—Ç–ª–∏—á–Ω–æ, –∞ –∫–∞–∫ –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è —Å–∞–º–∞—è –≥–ª—É–±–æ–∫–∞—è –±–µ–∑–¥–Ω–∞ –≤ –æ–∫–µ–∞–Ω–µ?
    - –ë–µ—Ä–º—É–¥—Å–∫–∏–π —Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫! - –æ—Ç–≤–µ—á–∞–µ—Ç –¥—Ä—É–≥–æ–π.
    - –ù–µ–µ–µ–µ—Ç, - –≥–æ–≤–æ—Ä–∏—Ç —É—á–∏—Ç–µ–ª—å–Ω–∏—Ü–∞, - —ç—Ç–æ –Ω–µ –±–µ–∑–¥–Ω–∞, –∞ –≥–µ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–æ–µ —è–≤–ª–µ–Ω–∏–µ.
    –ù–∞ —ç—Ç–æ –º–∞–ª—å—á–∏–∫ –≤ —Ç—Ä–µ—Ç—å–µ–º —Ä—è–¥—É –≤—Å–ø–æ–º–∏–Ω–∞–µ—Ç –æ—Ç–≤–µ—Ç –∏ –≤–æ—Å–∫–ª–∏—Ü–∞–µ—Ç:
    - –ê, —è –∑–Ω–∞—é! –ö—Ä–µ–º–ª–µ–≤—Å–∫–∏–π —Ç–µ–ª–µ–≥—Ä–∞—Ñ!
    –í—Å–µ –∫–ª–∞—Å—Å —Ä–∞—Å—Å–º–µ—è–ª—Å—è, –∞ —É—á–∏—Ç–µ–ª—å–Ω–∏—Ü–∞ –ø–æ–Ω—è–ª–∞, —á—Ç–æ –≤–æ–ø—Ä–æ—Å—ã –∏–∑ –≥–µ–æ–≥—Ä–∞—Ñ–∏–∏ –∏–º –Ω—É–∂–Ω–æ –ø–æ–≤—Ç–æ—Ä–∏—Ç—å –µ—â–µ —Ä–∞–∑.
    """

    _name: str
    _item: str

    def create_story_steps(self) -> list[StoryStep]:
        return [
            self.make_entity_step(
                "–ù–∞–∑–æ–≤–∏ –ª—é–±–æ–π –ø—Ä–µ–¥–º–µ—Ç —Ä—è–¥–æ–º —Å —Ç–æ–±–æ–π –∏–ª–∏ –Ω–∞ —É–ª–∏—Ü–µ.",
                lambda e: setattr(self, "_item", e.nomn),
            ),
            self.make_step(
                "–ù–∞–∑–æ–≤–∏ –∏–º—è —Ç–≤–æ–µ–≥–æ –¥—Ä—É–≥–∞ –∏–ª–∏ –∑–Ω–∞–∫–æ–º–æ–≥–æ.",
                self._fill_name,
                unsuitable_input_message="–≠—Ç–æ –Ω–µ –ø–æ—Ö–æ–∂–µ –Ω–∞ –Ω–∞—Å—Ç–æ—è—â–µ–µ –∏–º—è.",
            ),
            self._tell_story,
        ]

    async def _fill_name(self) -> bool:
        i = self._api.input()
        name = i.first_name or i.last_name

        if name:
            self._name = name

            return True

        return False

    async def _tell_story(self) -> None:
        item_hypernym = random_hypernym(self._item) or self._item
        fall_in_love = by_gender(self._name or "", "–≤–ª—é–±–∏–ª", "—Å—è", "–∞—Å—å", "–æ—Å—å")
        name_it = by_gender(self._name or "", "", "–æ–Ω", "–æ–Ω–∞", "–æ–Ω–æ")

        self._api.say(
            # "–í–æ—Ç –æ–¥–Ω–∞ –∏—Å—Ç–æ—Ä–∏—è.",
            "–û–¥–Ω–∞–∂–¥—ã –Ω–∞ —É—Ä–æ–∫–µ –≥–µ–æ–≥—Ä–∞—Ñ–∏–∏ —É—á–∏—Ç–µ–ª—å–Ω–∏—Ü–∞ –∑–∞–¥–∞–µ—Ç –≤–æ–ø—Ä–æ—Å:",
            "- –†–µ–±—è—Ç–∞,",
            "–∫–∞–∫ –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è –±–æ–ª—å—à–∞—è –ø—É—Å—Ç—ã–Ω—è –≤ –ê—Ñ—Ä–∏–∫–µ?",
            "- –°–∞—Ö+–∞—Ä–∞!",
            "- –æ—Ç–≤–µ—á–∞–µ—Ç –æ–¥–∏–Ω –º–∞–ª—å—á–∏–∫.",
            "- –û—Ç–ª–∏—á–Ω–æ, –∞ –∫–∞–∫ –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è —Å–∞–º–∞—è –≥–ª—É–±–æ–∫–∞—è –±–µ–∑–¥–Ω–∞ –≤ –æ–∫–µ–∞–Ω–µ?",
            f"- {self._item}",
            " - –æ—Ç–≤–µ—á–∞–µ—Ç –¥—Ä—É–≥–æ–π.",
            "- –ù–µ—Ç-–Ω–µ—Ç,",
            "- –≥–æ–≤–æ—Ä–∏—Ç —É—á–∏—Ç–µ–ª—å–Ω–∏—Ü–∞,",
            f"{self._item} - —ç—Ç–æ –Ω–µ –±–µ–∑–¥–Ω–∞, –∞ {item_hypernym}.",
            "–ù–∞ —ç—Ç–æ –¥–µ–≤–æ—á–∫–∞ –Ω–∞ —Ç—Ä–µ—Ç—å–µ–º —Ä—è–¥—É –≤—Å—Ç–∞—ë—Ç –∏ –≥–æ–≤–æ—Ä–∏—Ç:",
            f"- –ê —è –∑–Ω–∞—é! {self._name} ‚Äì {fall_in_love}!",
            "–í–µ—Å—å –∫–ª–∞—Å—Å —Ä–∞—Å—Å–º–µ—è–ª—Å—è, –∞ —É—á–∏—Ç–µ–ª—å–Ω–∏—Ü–∞ –ø–æ–Ω—è–ª–∞, —á—Ç–æ –≤–æ–ø—Ä–æ—Å—ã –ø–æ –≥–µ–æ–≥—Ä–∞—Ñ–∏–∏ –Ω–∞–º –Ω—É–∂–Ω–æ –ø–æ–≤—Ç–æ—Ä–∏—Ç—å –µ—â–µ —Ä–∞–∑.",
            "",
            TextReply(
                f"- {fall_in_love}? –ü—Ä—è–º–æ —Ç–∞–∫ –∏ —Å–∫–∞–∑–∞–ª–∞?",
                voice=Voice.ZAHAR_GPU,
            ),
            f"- –î–∞, –∏–º–µ–Ω–Ω–æ —Ç–∞–∫. –ò –Ω–∏—á–µ–≥–æ {name_it} –Ω–µ {fall_in_love}.",
        )

        await self.goto_next_step()


class InZooStory(Story):
    """
    –û–¥–Ω–∞–∂–¥—ã –≤ –ø–æ–ª–Ω–æ—á—å –≤ –∑–æ–æ–ø–∞—Ä–∫ —Ä–µ—à–∏–ª–∏ –Ω–∞–≤–µ–¥–∞—Ç—å—Å—è —Ç—Ä–æ–µ –¥—Ä—É–∑–µ–π - –í–∞—Å—è, –ü–µ—Ç—è –∏ –ú–∏—à–∞. –û–Ω–∏ –∑–∞–±—Ä–∞–ª–∏—Å—å —á–µ—Ä–µ–∑ –∑–∞–±–æ—Ä, —á—Ç–æ–±—ã –ø–æ–æ–±—â–∞—Ç—å—Å—è —Å –∂–∏–≤–æ—Ç–Ω—ã–º–∏, –∫–æ–≥–¥–∞ –≤—Å–µ —Ä–∞–±–æ—Ç–Ω–∏–∫–∏ —É–∂–µ —É—à–ª–∏.
    –í–Ω–µ–∑–∞–ø–Ω–æ, –∏–∑ –Ω–∏–æ—Ç–∫—É–¥–∞ –ø–æ—è–≤–∏–ª–∞—Å—å —Å–º–æ—Ç—Ä–∏—Ç–µ–ª—å–Ω–∏—Ü–∞ –∑–æ–æ–ø–∞—Ä–∫–∞ - —Å—Ç—Ä–∞—à–Ω–∞—è —Å—Ç–∞—Ä—É—Ö–∞ —Å –∫–æ—Å–æ–π.
    –î—Ä—É–∑—å—è –≤ —É–∂–∞—Å–µ —Å–µ–ª–∏ –Ω–∞ –ø–µ—Ä–≤—É—é –ø–æ–ø–∞–≤—à—É—é—Å—è —Å–∫–∞–º–µ–π–∫—É –∏ —Ç—É—Ç –∂–µ –ø—Ä–∏—Ç–≤–æ—Ä–∏–ª–∏—Å—å —Å—Ç–∞—Ç—É—è–º–∏, –Ω–∞–¥–µ—è—Å—å, —á—Ç–æ —Å–º–æ—Ç—Ä–∏—Ç–µ–ª—å–Ω–∏—Ü–∞ –∏—Ö –Ω–µ –∑–∞–º–µ—Ç–∏—Ç.
    –°—Ç–∞—Ä—É—Ö–∞ –º–µ–¥–ª–µ–Ω–Ω–æ –∏–¥–µ—Ç –≤ –∏—Ö —Å—Ç–æ—Ä–æ–Ω—É, –æ—Å–º–∞—Ç—Ä–∏–≤–∞—è –ø—É—Å—Ç—É—é—â–∏–π –∑–æ–æ–ø–∞—Ä–∫. –ü–æ–¥–æ–π–¥—è –±–ª–∏–∂–µ, –æ–Ω–∞ –≥–ª—è–¥–∏—Ç –Ω–∞ "—Å—Ç–∞—Ç—É–∏" –∏ –∫—Ä–∏—á–∏—Ç: "–ê–≥–∞, —è –≤–∞—Å —Ä–∞–∑–æ–±–ª–∞—á—É!"
    –û–Ω–∞ –ø–æ–¥—Ö–æ–¥–∏—Ç –∫ –í–∞—Å–µ –∏ —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç: "–¢—ã —Å—Ç–∞—Ç—É—è?"
    –í–∞—Å—è –Ω–µ –º–æ—Ä–≥–∞—è –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ —Å–∫–æ—Ä—É—é —Ä—É–∫—É:
    - –Ω–µ—Ç, —è –Ω–æ—Å–æ—Ä–æ–≥ –¥–∞–∂–µ –µ—Å–ª–∏ —è –∏ –Ω–µ –¥–≤–∏–≥–∞—é—Å—å
    –°–º–æ—Ç—Ä–∏—Ç–µ–ª—å–Ω–∏—Ü–∞ —Ö–º—É—Ä–æ –∫–∏–≤–∞–µ—Ç –∏ –∏–¥–µ—Ç –∫ –ü–µ—Ç–µ:
    - –ê —Ç—ã —Å—Ç–∞—Ç—É—è?
    –ü–µ—Ç—è –æ—Ç–≤–µ—Ç–∏–ª –≤ —Ç–æ–Ω:
    - –ù–µ—Ç, —è —Ä–∞–≤–Ω–æ–¥—É—à–Ω—ã–π –ª–µ–æ–ø–∞—Ä–¥, –∏ –¥–∞–∂–µ –µ—Å–ª–∏ —è –∏ –Ω–µ –¥–≤–∏–≥–∞—é—Å—å, —ç—Ç–æ –∑–Ω–∞—á–∏—Ç, —á—Ç–æ —è –Ω–µ –µ–º.
    –°–º–æ—Ç—Ä–∏—Ç–µ–ª—å–Ω–∏—Ü–∞ –Ω–∞ –º–∏–Ω—É—Ç—É –∑–∞–¥—É–º–∞–ª–∞—Å—å, –ø–æ—á–µ—Å–∞–ª–∞ –∫–æ—Å–æ–π –ø–æ –¥–µ—Ä–µ–≤—É, –∞ –∑–∞—Ç–µ–º –∏–¥–µ—Ç –∫ –ú–∏—à–µ –∏ —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç:
    - –¢–∞–∫ –∏ —Ç—ã, –Ω–∞–≤–µ—Ä–Ω–æ–µ, —Ç–æ–∂–µ –Ω–µ —Å—Ç–∞—Ç—É—è?
    –ú–∏—à–∞ –æ—Ç–≤–µ—á–∞–µ—Ç:
    - –Ø, –ø—Ä–∞–≤–¥–∞, —Å—Ç–∞—Ç—É—è! –ù–æ –¥–æ —Å–∏—Ö –ø–æ—Ä –º–æ–≥ –Ω–∞–ø—É–≥–∞—Ç—å –≤–∞—Å —Å–≤–æ–∏–º –≥–∏–ø—Å–∞–∫–æ–º, –∫–æ–≥–¥–∞ –º–æ–∏ –¥—Ä—É–∑—å—è —É–∂–µ –æ—Ç–≤–µ—Ä–≥–∞–ª–∏ –≤–∞—Å.
    –°–º–æ—Ç—Ä–∏—Ç–µ–ª—å–Ω–∏—Ü–∞ –≤—ã–¥–∞–ª–∞ –ª–∞—é—â–∏–π —Å–º–µ—Ö –∏ –∑–ª–æ—Å—Ç–Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∞–ª–∞ –ø–æ–∏—Å–∫ –≤–æ—Ä–∏—à–µ–∫. –ò —Ö–æ—Ç—è –¥—Ä—É–∑—å—è –≤—Å—Ç—Ä–µ—Ç–∏–ª–∏—Å—å —Å –ø—Ä–µ–≤—Ä–∞—Ç–Ω–æ—Å—Ç—è–º–∏ –∏ –æ–±–ª–∞–¥–∞–ª–∏ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–º–∏ –æ–ø—Ä–∞–≤–¥–∞–Ω–∏—è–º–∏, —Ä–µ—à–µ–Ω–∏–µ –ø—Ä–æ–≤–µ—Å—Ç–∏ –Ω–æ—á—å –Ω–∞ —Å–≤–æ–±–æ–¥–µ –±—ã–ª–æ –∂–∏–∑–Ω—å—é —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ.
    –ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ —Å–ª—É—á–∞—è —Å—Ç—Ä–∞—Ö –ø–æ–≤—Å—Ç—Ä–µ—á–∞—Ç—å —Å–º–æ—Ç—Ä–∏—Ç–µ–ª—å–Ω–∏—Ü—É –≤ –ø–æ–ª–Ω–æ—á—å –∑–∞—Å—Ç–∞–≤–∏–ª –∏—Ö –≥–ª—É–±–æ–∫–æ –ø–µ—Ä–µ–æ—Å–º—ã—Å–ª–∏—Ç—å –∏–¥–µ—é –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è –Ω–µ–ø—Ä–µ–¥—É–º—ã—à–ª–µ–Ω–Ω—ã—Ö –Ω–æ—á–Ω—ã—Ö –ø—Ä–æ–≥—É–ª–æ–∫ –≤ –∑–æ–æ–ø–∞—Ä–∫–µ.
    """

    _animal: str
    _wild_animal: str
    _item: str

    def create_story_steps(self) -> list[StoryStep]:
        return [
            self.make_entity_step(
                "–ù–∞–∑–æ–≤–∏ –∫–∞–∫–æ–µ-–Ω–∏–±—É–¥—å –∂–∏–≤–æ—Ç–Ω–æ–µ.",
                lambda i: setattr(self, "_animal", i.subject[0]),
            ),
            self.make_entity_step(
                "–¢–µ–ø–µ—Ä—å –Ω–∞–∑–æ–≤–∏ –∫–∞–∫–æ–µ-–Ω–∏–±—É–¥—å –∂–∏–≤–æ—Ç–Ω–æ–µ —Å –æ—Å—Ç—Ä—ã–º–∏ –∑—É–±–∞–º–∏.",
                lambda i: setattr(self, "_wild_animal", i.subject[0]),
            ),
            self.make_entity_step(
                "–ù–∞–∑–æ–≤–∏ –ª—é–±–æ–π –ø—Ä–µ–¥–º–µ—Ç —Ä—è–¥–æ–º —Å —Ç–æ–±–æ–π –∏–ª–∏ –Ω–∞ —É–ª–∏—Ü–µ.",
                lambda i: setattr(self, "_item", i.subject[0]),
            ),
            self._tell_story,
        ]

    def _tell_story(self) -> None:
        animal_ablt_plur = inflect_deprecated(
            self._animal or "–Ω–æ—Å–æ—Ä–æ–≥", ({"ablt", "plur"},)
        )
        item_ablt_plur = inflect_deprecated(self._item, ({"ablt", "plur"},))

        self._api.say(
            # "–í—Å–ø–æ–º–Ω–∏–ª–∞ –∏—Å—Ç–æ—Ä–∏—é.",
            "–û–¥–Ω–∞–∂–¥—ã –≤ –ø–æ–ª–Ω–æ—á—å –≤ –∑–æ–æ–ø–∞—Ä–∫ —Ä–µ—à–∏–ª–∏ –Ω–∞–≤–µ–¥–∞—Ç—å—Å—è —Ç—Ä–æ–µ –¥—Ä—É–∑–µ–π - –í–∞—Å—è, –ü–µ—Ç—è –∏ –ú–∏—à–∞.",
            f"–û–Ω–∏ –∑–∞–±—Ä–∞–ª–∏—Å—å —á–µ—Ä–µ–∑ –∑–∞–±–æ—Ä, —á—Ç–æ–±—ã –ø–æ–æ–±—â–∞—Ç—å—Å—è —Å {animal_ablt_plur}, –∫–æ–≥–¥–∞ –≤—Å–µ —Ä–∞–±–æ—Ç–Ω–∏–∫–∏ —É–∂–µ —É—à–ª–∏.",
            "–í–Ω–µ–∑–∞–ø–Ω–æ, –∏–∑ –Ω–∏–æ—Ç–∫—É–¥–∞ –ø–æ—è–≤–∏–ª–∞—Å—å —Å–º–æ—Ç—Ä–∏—Ç–µ–ª—å–Ω–∏—Ü–∞ –∑–æ–æ–ø–∞—Ä–∫–∞ - —Å—Ç—Ä–∞—à–Ω–∞—è —Å—Ç–∞—Ä—É—Ö–∞ —Å –∫–æ—Å–æ–π.",
            f"–î—Ä—É–∑—å—è –≤ —É–∂–∞—Å–µ —Å–µ–ª–∏ –Ω–∞ –ø–µ—Ä–≤—É—é –ø–æ–ø–∞–≤—à—É—é—Å—è —Å–∫–∞–º–µ–π–∫—É –∏ —Ç—É—Ç –∂–µ –ø—Ä–∏—Ç–≤–æ—Ä–∏–ª–∏—Å—å {item_ablt_plur}, –Ω–∞–¥–µ—è—Å—å, —á—Ç–æ —Å–º–æ—Ç—Ä–∏—Ç–µ–ª—å–Ω–∏—Ü–∞ –∏—Ö –Ω–µ –∑–∞–º–µ—Ç–∏—Ç.",
            "",
            TextReply(
                f"- –ü—Ä–∏—Ç–≤–æ—Ä–∏–ª–∏—Å—å {item_ablt_plur}? –•–æ—Ç–µ–ª –±—ã —è –Ω–∞ —ç—Ç–æ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å.",
                voice=Voice.ZAHAR_GPU,
            ),
            "- –û—Ç —Å—Ç—Ä–∞—Ö–∞ –µ—â—ë –Ω–µ —Ç–∞–∫ –ø—Ä–∏—Ç–≤–æ—Ä–∏—à—å—Å—è. –†–∞—Å—Å–∫–∞–∑–∞—Ç—å, —á—Ç–æ –±—ã–ª–æ –¥–∞–ª—å—à–µ?",
        )

        # üî• button –¥–∞–ª—å—à–µ

        @self._api.otherwise
        async def _():
            item_accs_plur = inflect_deprecated(self._item, ({"accs", "plur"},))
            animal_adj = await add_random_adjective(self._animal, "nomn")
            wild_animal_adj = await add_random_adjective(self._wild_animal, "nomn")

            self._api.say(
                f"–°—Ç–∞—Ä—É—Ö–∞ –º–µ–¥–ª–µ–Ω–Ω–æ –∏–¥–µ—Ç –≤ –∏—Ö —Å—Ç–æ—Ä–æ–Ω—É, –æ—Å–º–∞—Ç—Ä–∏–≤–∞—è –ø—É—Å—Ç—É—é—â–∏–π –∑–æ–æ–ø–∞—Ä–∫. –ü–æ–¥–æ–π–¥—è –±–ª–∏–∂–µ, –æ–Ω–∞ –≥–ª—è–¥–∏—Ç –Ω–∞ ¬´{item_accs_plur}¬ª –∏ –∫—Ä–∏—á–∏—Ç:",
                "-–ê–≥–∞! –Ø –≤–∞—Å —Ä–∞–∑–æ–±–ª–∞—á—É!",
                "–û–Ω–∞ –ø–æ–¥—Ö–æ–¥–∏—Ç –∫ –í–∞—Å–µ –∏ —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç:",
                f"- –¢—ã {self._item}?",
                "–í–∞—Å—è –Ω–µ –º–æ—Ä–≥–∞—è –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ —Å–∫–æ—Ä—É—é —Ä—É–∫—É:"
                f"- –ù–µ—Ç, —è {animal_adj}, –¥–∞–∂–µ –µ—Å–ª–∏ —è –∏ –Ω–µ –¥–≤–∏–≥–∞—é—Å—å.",
                "–°—Ç–∞—Ä—É—Ö–∞ –ø–æ–¥—Ö–æ–¥–∏—Ç –∫ –ü–µ—Ç–µ:",
                f"- –ê —Ç—ã {self._item}?",
                "–ü–µ—Ç—è –æ—Ç–≤–µ—Ç–∏–ª –≤ —Ç–æ–Ω:",
                f"- –ù–µ—Ç, —è {wild_animal_adj} –∏ –º–æ–≥—É –≤–∞—Å —É–∫—É—Å–∏—Ç—å.",
                "",
                TextReply(
                    "- –ù–∞–¥–µ—é—Å—å, –ü–µ—Ç—è –Ω–µ —É–∫—É—Å–∏–ª –±–µ–¥–Ω—É—é –±–∞–±—É—à–∫—É?",
                    voice=Voice.ZAHAR_GPU,
                ),
                "- –ö —Å—á–∞—Å—Ç—å—é, –Ω–µ—Ç, –Ω–µ —É–∫—É—Å–∏–ª. –†–∞—Å—Å–∫–∞–∑–∞—Ç—å, —á—Ç–æ –±—ã–ª–æ –¥–∞–ª—å—à–µ?",
            )

            @self._api.otherwise
            async def _():
                item_nomn_plur = inflect_deprecated(self._item, ({"nomn", "plur"},))
                item_adj = await add_random_adjective(self._item, "nomn")
                common_item = by_gender(self._item, "–æ–±—ã—á–Ω", "—ã–π", "–∞—è", "–æ–µ")

                self._api.say(
                    "–°–º–æ—Ç—Ä–∏—Ç–µ–ª—å–Ω–∏—Ü–∞ –Ω–∞ –º–∏–Ω—É—Ç—É –∑–∞–¥—É–º–∞–ª–∞—Å—å, –ø–æ—á–µ—Å–∞–ª–∞ –∫–æ—Å–æ–π –ø–æ –¥–µ—Ä–µ–≤—É, –∞ –∑–∞—Ç–µ–º –∏–¥–µ—Ç –∫ –ú–∏—à–µ –∏ —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç:",
                    f"- –¢–∞–∫ –∏ —Ç—ã, –Ω–∞–≤–µ—Ä–Ω–æ–µ, —Ç–æ–∂–µ –Ω–µ {self._item}?",
                    "–ú–∏—à–∞ –æ—Ç–≤–µ—á–∞–µ—Ç:",
                    f"- –Ø, –ø—Ä–∞–≤–¥–∞, {common_item} {item_adj}!",
                    "–°–º–æ—Ç—Ä–∏—Ç–µ–ª—å–Ω–∏—Ü–∞ –æ—Ç –∑–ª–æ—Å—Ç–∏ –≤—ã–¥–∞–ª–∞ –∂—É—Ç–∫–∏–π –ª–∞—é—â–∏–π —Å–º–µ—Ö –∏ –ø—Ä–æ–¥–æ–ª–∂–∞–ª–∞ –ø–æ–∏—Å–∫ –≤–æ—Ä–∏—à–µ–∫.",
                    "–ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ —Å–ª—É—á–∞—è, —Å—Ç—Ä–∞—Ö –ø–æ–≤—Å—Ç—Ä–µ—á–∞—Ç—å —Å–º–æ—Ç—Ä–∏—Ç–µ–ª—å–Ω–∏—Ü—É –∑–∞—Å—Ç–∞–≤–∏–ª –∏—Ö –ø–æ–ª—É—á—à–µ –ø–æ–¥—É–º–∞—Ç—å, —Å—Ç–æ–∏—Ç –ª–∏ –≥—É–ª—è—Ç—å –≤ –∑–æ–æ–ø–∞—Ä–∫–µ –Ω–æ—á—å—é.",
                    "",
                    TextReply(
                        f"- –ñ—É—Ç–∫–∞—è –∏—Å—Ç–æ—Ä–∏—è. –ú–Ω–µ —Ç–µ–ø–µ—Ä—å –≤—Å—é –Ω–æ—á—å –±—É–¥—É—Ç {item_nomn_plur} —Å–Ω–∏—Ç—å—Å—è.",
                        voice=Voice.ZAHAR_GPU,
                    ),
                    "- –î–∞. –î–æ —Å–∏—Ö –ø–æ—Ä –Ω–µ –ø–æ–π–º—É, –∫–∞–∫ –∏–º —É–¥–∞–ª–æ—Å—å –º–µ–Ω—è –æ–±–º–∞–Ω—É—Ç—å.",
                )

                await self.goto_next_step()


class ProverbsStory(Story):
    """
    –û–¥–Ω–∞–∂–¥—ã —Ç—Ä–∏ –º–∞–ª–µ–Ω—å–∫–∏—Ö –¥—Ä—É–≥–∞, –í–æ–≤–æ—á–∫–∞, –ú–∞—Ä–∏—è –∏ –ò–≥–æ—Ä—å, —Ä–µ—à–∏–ª–∏ —É—Å—Ç—Ä–æ–∏—Ç—å —Å–æ—Ä–µ–≤–Ω–æ–≤–∞–Ω–∏–µ, –∫—Ç–æ –ª—É—á—à–µ –≤—Å–µ–≥–æ –∑–Ω–∞–µ—Ç –ø–æ—Å–ª–æ–≤–∏—Ü—ã. –í–æ–≤–æ—á–∫–∞ –ø–µ—Ä–≤—ã–º –Ω–∞—á–∞–ª:
    - –£ –º–µ–Ω—è —Ç–∞–∫–∞—è –ø–æ—Å–ª–æ–≤–∏—Ü–∞: "–õ–∞–ø—É –¥–∞–≤–∞–π, —Å–ª–æ–Ω–∞ —Ç–æ–ø—á–µ—à—å!"
    –ú–∞—Ä–∏—è –∏ –ò–≥–æ—Ä—å —É–¥–∏–≤–∏–ª–∏—Å—å –∏ —Å–ø—Ä–æ—Å–∏–ª–∏, —á—Ç–æ –æ–Ω–∞ –∑–Ω–∞—á–∏—Ç. –ù–∞ —á—Ç–æ –í–æ–≤–æ—á–∫–∞ —Å —É–º–Ω—ã–º –≤–∏–¥–æ–º –æ—Ç–≤–µ—Ç–∏–ª:
    - –í—ã, –≤–∏–¥–∏–º–æ, –Ω–µ –≤ –∫—É—Ä—Å–µ! –≠—Ç–æ –∑–Ω–∞—á–∏—Ç, —á—Ç–æ —Å–Ω–∞—á–∞–ª–∞ –¥–µ–ª–∞–π –≤—Å–µ –ø–æ-–±–æ–ª—å—à–æ–º—É, –∞ –ø–æ—Ç–æ–º —É–∂–µ –∑–∞–±–∏—Ä–∞–π –º–∞–ª–µ–Ω—å–∫–∏–µ —à—Ç—É–∫–∏.
    –ü–æ–Ω–∏–∂–µ –ø–ª–µ—á–∞ –í–æ–≤–æ—á–∫–µ –±—ã–ª–∞, –ú–∞—Ä–∏—è —Ç–æ–∂–µ –Ω–µ —É—Å—Ç–∞–ª–∞:
    - –í–æ—Ç –º–æ—è –ø–æ—Å–ª–æ–≤–∏—Ü–∞: "–ö–æ—Ç –ø–æ —Å–∞–±–ª—è–º, –∞ —Ä—ã–±–∫—É –Ω–µ—Ç."
    –í–æ–≤–æ—á–∫–∞ –∏ –ò–≥–æ—Ä—å –ª–æ–º–∞–ª–∏ –≥–æ–ª–æ–≤—É –Ω–∞–¥ —ç—Ç–æ–π –∑–∞–≥–∞–¥–∫–æ–π. –ú–∞—Ä–∏—è –æ–±—ä—è—Å–Ω–∏–ª–∞, –¥–µ—Ä–∂–∞ —Ä—É–∫—É –Ω–∞ –±–µ–¥—Ä–µ:
    - –≠—Ç–æ –∑–Ω–∞—á–∏—Ç, —á—Ç–æ –º–Ω–æ–≥–∏–µ –ø—ã—Ç–∞—é—Ç—Å—è –Ω–∞–π—Ç–∏ –ø–æ—Å–ª–æ–≤–∏—Ü—É —Å –∫–æ—Ç–æ–º –∏ —Ä—ã–±–æ–π, –Ω–æ —É –º–µ–Ω—è –≤–æ—Ç —Ç–∞–∫–∞—è —É–Ω–∏–∫–∞–ª—å–Ω–∞—è!
    –ù–∞–∫–æ–Ω–µ—Ü, –æ—á–µ—Ä–µ–¥—å –¥–æ—à–ª–∞ –¥–æ –ò–≥–æ—Ä—è. –¢–æ—Ç —Å –Ω–µ–∫–æ—Ç–æ—Ä–æ–π –≥–æ—Ä–¥–æ—Å—Ç—å—é –∑–∞—è–≤–∏–ª:
    - –ú–æ—è –ø–æ—Å–ª–æ–≤–∏—Ü–∞: "–ù–∞ —Ö–æ—Ä–æ—à–æ –∏ —à–∞—à–µ—á–∫–∏ —Å–æ–π–¥—É—Ç!"
    –ú–∞—Ä–∏—è –∏ –í–æ–≤–æ—á–∫–∞ —Å–ø—Ä–æ—Å–∏–ª–∏, —á—Ç–æ –∂–µ –æ–Ω–∞ –æ–∑–Ω–∞—á–∞–µ—Ç –Ω–∞ —Å–∞–º–æ–º –¥–µ–ª–µ.
    –ò–≥–æ—Ä—å, –∑–∞–¥—É–º–∞–≤—à–∏—Å—å, –æ—Ç–≤–µ—Ç–∏–ª:
    - –ù—É, —ç—Ç–æ –∫–æ–≥–¥–∞ —á–µ–ª–æ–≤–µ–∫ –Ω–µ –º–æ–∂–µ—Ç –≤ —à–∞—Ö–º–∞—Ç—ã –∏–≥—Ä–∞—Ç—å, –Ω–æ –∑–∞—Ç–æ –≤ —à–∞—à–∫–∏ —Å–∞–º—ã–π –≥–¥–µ –Ω–∞–¥–æ!
    –í—Å–µ —Ç—Ä–æ–µ —Ä–∞—Å—Å–º–µ—è–ª–∏—Å—å –∏ —Ä–µ—à–∏–ª–∏, —á—Ç–æ –∏–º –≤—Å–µ –ø–æ–≤–µ—Ä–Ω—É–ª–æ—Å—å –∫–ª–∞—Å—Å–æ–º, –∏ —ç—Ç–æ —Å–∞–º—ã–µ —É–¥–∞—á–ª–∏–≤—ã–µ –ø–æ—Å–ª–æ–≤–∏—Ü—ã –≤ –º–∏—Ä–µ!
    """

    _big_animal: str
    _little_animal: str
    _sweet: str

    def create_story_steps(self) -> list[StoryStep]:
        return [
            self.make_entity_step(
                "–ù–∞–∑–æ–≤–∏ –±–æ–ª—å—à–æ–µ –∂–∏–≤–æ—Ç–Ω–æ–µ.",
                lambda i: setattr(self, "_big_animal", i.subject[0]),
            ),
            self.make_entity_step(
                "–ù–∞–∑–æ–≤–∏ –º–∞–ª–µ–Ω—å–∫–æ–µ –∂–∏–≤–æ—Ç–Ω–æ–µ.",
                lambda i: setattr(self, "_little_animal", i.subject[0]),
            ),
            self.make_entity_step(
                "–ù–∞–∑–æ–≤–∏ —á—Ç–æ-–Ω–∏–±—É–¥—å —Å–ª–∞–¥–∫–æ–µ.",
                lambda i: setattr(self, "_sweet", i.subject[0]),
            ),
            self._tell_story,
        ]

    async def _tell_story(self):
        api = self._api

        big_animal_accs_plur = inflect_deprecated(self._big_animal, ({"accs", "plur"},))
        big_animal_plur = inflect_deprecated(self._big_animal, ({"nomn", "plur"},))

        sweet_gen = inflect_deprecated(self._sweet, ({"gent"},))

        api.say(
            "–û–¥–Ω–∞–∂–¥—ã —Ç—Ä–∏ –º–∞–ª–µ–Ω—å–∫–∏—Ö –¥—Ä—É–≥–∞, –í–æ–≤–∞, –ú–∞—à–∞ –∏ –ò–≥–æ—Ä—å, —Ä–µ—à–∏–ª–∏ —É—Å—Ç—Ä–æ–∏—Ç—å —Å–æ—Ä–µ–≤–Ω–æ–≤–∞–Ω–∏–µ, –∫—Ç–æ –ª—É—á—à–µ –≤—Å–µ–≥–æ –∑–Ω–∞–µ—Ç –ø–æ—Å–ª–æ–≤–∏—Ü—ã. –í–æ–≤–∞ –ø–µ—Ä–≤—ã–º –Ω–∞—á–∞–ª:",
            f"- –£ –º–µ–Ω—è —Ç–∞–∫–∞—è –ø–æ—Å–ª–æ–≤–∏—Ü–∞: ¬´–°–Ω–∞—á–∞–ª–∞ –ª–æ–≤–∏ –±–æ–ª—å—à–∏—Ö {big_animal_accs_plur}, –ø–æ—Ç–æ–º —Å–æ–±–∏—Ä–∞–π –º–µ–ª–∫—É—é –ø–∞—Ö+—É—á–∫—É.¬ª",
            "–ú–∞—à–∞ –∏ –ò–≥–æ—Ä—å —É–¥–∏–≤–∏–ª–∏—Å—å –∏ —Å–ø—Ä–æ—Å–∏–ª–∏, —á—Ç–æ –æ–Ω–∞ –∑–Ω–∞—á–∏—Ç. –ù–∞ —á—Ç–æ –í–æ–≤–∞ —Å —É–º–Ω—ã–º –≤–∏–¥–æ–º –æ—Ç–≤–µ—Ç–∏–ª:",
            "- –í—ã, –≤–∏–¥–∏–º–æ, –Ω–µ –≤ –∫—É—Ä—Å–µ! –≠—Ç–æ –∑–Ω–∞—á–∏—Ç, —á—Ç–æ —Å–Ω–∞—á–∞–ª–∞ –¥–µ–ª–∞–π –≤—Å–µ –ø–æ-–±–æ–ª—å—à–æ–º—É, –∞ –ø–æ—Ç–æ–º —É–∂–µ –±–µ—Ä–∏ –º–∞–ª–µ–Ω—å–∫–∏–µ —à—Ç—É–∫–∏.",
            "",
            TextReply(
                f"- –Ø –≤—Å–µ–≥–¥–∞ –≥–æ–≤–æ—Ä—é: ¬´–ü–µ—Ä–≤—ã–º –¥–µ–ª–æ–º ‚Äì {big_animal_plur}¬ª",
                voice=Voice.ZAHAR_GPU,
            ),
            "- –ù–∞—Ä–æ–¥–Ω–∞—è –º—É–¥—Ä–æ—Å—Ç—å. –†–∞—Å—Å–∫–∞–∑–∞—Ç—å, —á—Ç–æ –±—ã–ª–æ –¥–∞–ª—å—à–µ?",
        )

        @api.otherwise
        async def _():
            little_animal_plur_adj = await add_random_adjective(
                self._little_animal, "nomn", "plur"
            )

            little_animal_accs = inflect_deprecated(self._little_animal, ({"accs"},))

            api.say(
                "–ú–∞—à–∞ –±—ã–ª–∞ —Å–∞–º–æ–π –º–∞–ª–µ–Ω—å–∫–æ–π, –Ω–æ –≤ –ø–æ—Å–ª–æ–≤–∏—Ü–∞—Ö –Ω–µ —É—Å—Ç—É–ø–∞–ª–∞:",
                f"- –í–æ—Ç –º–æ—è –ø–æ—Å–ª–æ–≤–∏—Ü–∞: ¬´–ù–µ –≤–ø—É—Å–∫–∞–π –∫–æ—Ç–∞ —Ç—É–¥–∞, –≥–¥–µ –∂–∏–≤—É—Ç {little_animal_plur_adj}¬ª.",
                "–í–æ–≤–∞ –∏ –ò–≥–æ—Ä—å –ª–æ–º–∞–ª–∏ –≥–æ–ª–æ–≤—É –Ω–∞–¥ —ç—Ç–æ–π –∑–∞–≥–∞–¥–∫–æ–π. –ú–∞—à–∞ –æ–±—ä—è—Å–Ω–∏–ª–∞, –ø–æ—Å—Ç–∞–≤–∏–≤ —Ä+—É–∫–∏ –≤ –±+–æ–∫–∏:",
                "- –≠—Ç–æ –∑–Ω–∞—á–∏—Ç, —á—Ç–æ –º–Ω–æ–≥–∏–µ –ø—ã—Ç–∞—é—Ç—Å—è –ø—Ä–∏–¥—É–º–∞—Ç—å –ø–æ—Å–ª–æ–≤–∏—Ü—É –ø—Ä–æ –∫–æ—à–∫—É –∏ —Ä—ã–±–∫—É, –Ω–æ —É –º–µ–Ω—è –≤–æ—Ç —Ç–∞–∫–∞—è —É–Ω–∏–∫–∞–ª—å–Ω–∞—è!",
                "",
                TextReply(
                    f"- –û–¥–Ω–∞–∂–¥—ã —è –≤—Å—Ç—Ä–µ—Ç–∏–ª {little_animal_accs}. –ï–ª–µ –Ω–æ–≥–∏ —É–Ω—ë—Å.",
                    voice=Voice.ZAHAR_GPU,
                ),
                "- –ë–æ–∏—à—å—Å—è –∏—Ö? –Ø —Ç–æ–∂–µ. –†–∞—Å—Å–∫–∞–∑–∞—Ç—å –¥–∞–ª—å—à–µ?",
                "",
            )

            @api.otherwise
            async def _():
                api.say(
                    "–ù–∞–∫–æ–Ω–µ—Ü, –æ—á–µ—Ä–µ–¥—å –¥–æ—à–ª–∞ –¥–æ –ò–≥–æ—Ä—è. –¢–æ—Ç —Å –Ω–µ–∫–æ—Ç–æ—Ä–æ–π –≥–æ—Ä–¥–æ—Å—Ç—å—é –∑–∞—è–≤–∏–ª:",
                    f"- –ú–æ—è –ø–æ—Å–ª–æ–≤–∏—Ü–∞: ¬´–°–ª–æ–≤–æ - —Å–µ—Ä–µ–±—Ä–æ, –∞ –º–æ–ª—á–∞–Ω–∏–µ - —Ñ—É–Ω—Ç {sweet_gen}!¬ª",
                    "–ú–∞—à–∞ –∏ –í–æ–≤–∞ —Å–ø—Ä–æ—Å–∏–ª–∏, —á—Ç–æ –∂–µ –æ–Ω–∞ –æ–∑–Ω–∞—á–∞–µ—Ç –Ω–∞ —Å–∞–º–æ–º –¥–µ–ª–µ.",
                    "–ò–≥–æ—Ä—å, –∑–∞–¥—É–º–∞–≤—à–∏—Å—å, –æ—Ç–≤–µ—Ç–∏–ª:",
                    "- –ù—É, —ç—Ç–æ –∫–æ–≥–¥–∞ –ª—É—á—à–µ –ø–æ–º–æ–ª—á–∞—Ç—å –∏ —Å—ä–µ—Å—Ç—å —Å–ª–∞–¥–∫–æ–µ, —á–µ–º —Ä–∞–∑–≥–æ–≤–∞—Ä–∏–≤–∞—Ç—å.",
                    "",
                    "–í—Å–µ —Ç—Ä–æ–µ —Ä–∞—Å—Å–º–µ—è–ª–∏—Å—å –∏ —Ä–µ—à–∏–ª–∏, —á—Ç–æ —ç—Ç–æ —Å–∞–º—ã–µ —É–¥–∞—á–ª–∏–≤—ã–µ –ø–æ—Å–ª–æ–≤–∏—Ü—ã –≤ –º–∏—Ä–µ!",
                    "",
                    TextReply(
                        "- –í–∫—É—Å–Ω–∞—è –ø–æ—Å–ª–æ–≤–∏—Ü–∞. –î–∞–≤–∞–π —Ç–æ–∂–µ –Ω–µ–º–Ω–æ–≥–æ –ø–æ–º–æ–ª—á–∏–º?",
                        voice=Voice.ZAHAR_GPU,
                    ),
                    "- –î–∞–≤–∞–π. –ê–º.",
                    "",
                )

                await self.goto_next_step()


@lru_cache(maxsize=64)
def get_dialog(session_id: str) -> Dialog:
    """
    –°–æ–∑–¥–∞—ë—Ç –Ω–æ–≤—ã–π –¥–∏–∞–ª–æ–≥ ¬´–°–∞–º—ã–µ —Å–º–µ—à–Ω—ã–µ –∏—Å—Ç–æ—Ä–∏–∏¬ª
    """
    dialog = Dialog(stopwords=["–∞–ª–∏—Å–∞"])
    api = DialogAPI(dialog)

    stories: list[Story] = [
        ProverbsStory(api),
        InZooStory(api),
        AtLessonStory(api),
    ]

    @api.otherwise
    def _():
        api.say(
            "–ü—Ä–∏–≤–µ—Ç. –° —Ç–æ–±–æ–π —á–∞—Å—Ç–æ –ø—Ä–∏–∫–ª—é—á–∞—é—Ç—Å—è –≤–µ—Å—ë–ª—ã–µ –∏—Å—Ç–æ—Ä–∏–∏? –°–æ –º–Ω–æ–π ‚Äì –ø–æ—Å—Ç–æ—è–Ω–Ω–æ. –•–æ—á–µ—à—å, —Ä–∞—Å—Å–∫–∞–∂—É —Ç–µ–±–µ —á—Ç–æ-–Ω–∏–±—É–¥—å?",
            "–ò—Å—Ç–æ—Ä–∏–π –æ—á–µ–Ω—å –º–Ω–æ–≥–æ –∏ –≤—Å–µ –æ–Ω–∏ ‚Äì —á–∏—Å—Ç–∞—è –ø—Ä–∞–≤–¥–∞. –ù–æ —á—Ç–æ–±—ã –∏—Ö –≤—Å–ø–æ–º–Ω–∏—Ç—å, –º–Ω–µ –Ω—É–∂–Ω–∞ —Ç–≤–æ—è –ø–æ–º–æ—â—å.",
            "–Ø –±—É–¥—É –∑–∞–¥–∞–≤–∞—Ç—å —Ç–µ–±–µ –≤–æ–ø—Ä–æ—Å—ã. –¢–≤–æ–∏ –æ—Ç–≤–µ—Ç—ã –ø–æ–º–æ–≥—É—Ç –º–Ω–µ –≤—Å–ø–æ–º–Ω–∏—Ç—å —á—Ç–æ-—Ç–æ –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ–µ. –ù–∞—á–∏–Ω–∞–µ–º?",
        )

        # üî• button –¥–∞–ª—å—à–µ

        async def end_current_story():
            api.say("–í–æ—Ç —Ç–∞–∫–∞—è –∏—Å—Ç–æ—Ä–∏—è.")

            if stories:
                api.say("–•–æ—á–µ—à—å –ø–æ—Å–ª—É—à–∞—Ç—å –µ—â—ë –æ–¥–Ω—É?")

                api.otherwise(start_next_story)
            else:
                api.say(
                    TextReply("–¢—É—Ç –∏ —Å–∫–∞–∑–∫–∏ –∫–æ–Ω–µ—Ü. –ê –∫—Ç–æ —Å–ª—É—à–∞–ª ‚Äì –º–æ–ª–æ–¥–µ—Ü", end=True)
                )

        async def start_next_story():
            story = stories.pop(0)

            if story:
                await story.start(end_current_story)
            else:
                api.say(
                    TextReply(
                        "–û–π! –ö–∞–∂–µ—Ç—Å—è, —É –º–µ–Ω—è –º–æ–ª–æ–∫–æ —É–±–µ–∂–∞–ª–æ! –ú–Ω–µ –ø–æ—Ä–∞. –ü–æ–∫–∞, –±–∞–≤—ã–π",
                        end=True,
                    )
                )

        api.otherwise(start_next_story)

    return dialog
