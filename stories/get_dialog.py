from functools import lru_cache
from typing import Optional, Protocol
from dialoger import Dialog, TextReply, Voice
from dialoger.dialog_api import DialogAPI
from enrichment import add_random_adjective
from entity_parser import Entity
from morphy import by_gender


class Story(Protocol):
    def tell_story(self, api: DialogAPI) -> None:
        ...


class AtTheLessonStory:
    _name: Optional[str]
    _fruit: Optional[str]

    def tell_story(self, api: DialogAPI) -> None:
        self._ask_fruit(api)

    def _ask_fruit(self, api: DialogAPI) -> None:
        api.say("–ù–∞–∑–æ–≤–∏ —á—Ç–æ-–Ω–∏–±—É–¥—å —Å—ä–µ–¥–æ–±–Ω–æ–µ")

        @api.trigger(lambda i: i.entities())
        async def _(entities: list[Entity]):
            fruit = entities[0].nomn
            self._fruit = await add_random_adjective(fruit)

            self._ask_name(api)

        @api.otherwise
        def _():
            api.say("–û–π! –Ø –Ω–µ–º–Ω–æ–≥–æ –æ—Ç–≤–ª–µ–∫–ª–∞—Å—å. –ß—Ç–æ —Ç—ã –≥–æ–≤–æ—Ä–∏—à—å?")

            self._ask_fruit(api)

    def _ask_name(self, api: DialogAPI) -> None:
        api.say("–ù–∞–∑–æ–≤–∏ –∏–º—è —Ç–≤–æ–µ–≥–æ –¥—Ä—É–≥–∞ –∏–ª–∏ –∑–Ω–∞–∫–æ–º–æ–≥–æ")

        @api.trigger(lambda i: i.first_name or i.last_name)
        async def _(name: str):
            self._name = name

            self._tell_story(api)

        @api.otherwise
        def _():
            api.say("–û–π! –ò–Ω—Ç–µ—Ä–µ—Å–Ω–æ–µ –∏–º—è. –ü–æ–≤—Ç–æ—Ä–∏, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞.")

            self._ask_name(api)

    def _tell_story(self, api: DialogAPI) -> None:
        api.say(
            "–í–æ—Ç –æ–¥–Ω–∞ –∏—Å—Ç–æ—Ä–∏—è.",
            "–û–¥–Ω–∞–∂–¥—ã –Ω–∞ —É—Ä–æ–∫–µ –≥–µ–æ–≥—Ä–∞—Ñ–∏–∏ —É—á–∏—Ç–µ–ª—å–Ω–∏—Ü–∞ –∑–∞–¥–∞–µ—Ç –≤–æ–ø—Ä–æ—Å:",
            "\n- –†–µ–±—è—Ç–∞,",
            "–∫–∞–∫ –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è –±–æ–ª—å—à–∞—è –ø—É—Å—Ç—ã–Ω—è –≤ –ê—Ñ—Ä–∏–∫–µ?",
            "\n- –°–∞—Ö+–∞—Ä–∞!",
            " - –æ—Ç–≤–µ—á–∞–µ—Ç –æ–¥–∏–Ω –º–∞–ª—å—á–∏–∫.",
            "\n- –û—Ç–ª–∏—á–Ω–æ, –∞ –∫–∞–∫ –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è —Å–∞–º–∞—è –≥–ª—É–±–æ–∫–∞—è –±–µ–∑–¥–Ω–∞ –≤ –æ–∫–µ–∞–Ω–µ?",
            "\n- –ë–µ—Ä–º—É–¥—Å–∫–∏–π —Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫!",
            " - –æ—Ç–≤–µ—á–∞–µ—Ç –¥—Ä—É–≥–æ–π.",
            "\n- –ù–µ—Ç-–Ω–µ—Ç",
            ", - –≥–æ–≤–æ—Ä–∏—Ç —É—á–∏—Ç–µ–ª—å–Ω–∏—Ü–∞,",
            " - —ç—Ç–æ –Ω–µ –±–µ–∑–¥–Ω–∞, –∞ –≥–µ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–æ–µ —è–≤–ª–µ–Ω–∏–µ.",
            f"–ò —Ç—É—Ç {self._name} –Ω–∞ —Ç—Ä–µ—Ç—å–µ–º —Ä—è–¥—É –≤—Å–ø–æ–º–∏–Ω–∞–µ—Ç –æ—Ç–≤–µ—Ç –∏ –≥–æ–≤–æ—Ä–∏—Ç:",
            f"\n- –ê! –Ø –∑–Ω–∞—é! –≠—Ç–æ {self._fruit}!",
            "\n–í–µ—Å—å –∫–ª–∞—Å—Å —Ä–∞—Å—Å–º–µ—è–ª—Å—è, –∞ —É—á–∏—Ç–µ–ª—å–Ω–∏—Ü–∞ –ø–æ–Ω—è–ª–∞, —á—Ç–æ –≤–æ–ø—Ä–æ—Å—ã –ø–æ –≥–µ–æ–≥—Ä–∞—Ñ–∏–∏ –Ω–∞–º –Ω—É–∂–Ω–æ –ø–æ–≤—Ç–æ—Ä–∏—Ç—å –µ—â–µ —Ä–∞–∑.",
        )

        api.say(
            "",
            TextReply(
                f"\n- {self._fruit}? –ü—Ä—è–º–æ —Ç–∞–∫ –∏ {by_gender(self._name or '', '—Å–∫–∞–∑–∞–ª', '—Å–∫–∞–∑–∞–ª–∞', '—Å–∫–∞–∑–∞–ª')}?",
                voice=Voice.ZAHAR_GPU,
            ),
            "\n- –î–∞, –∏–º–µ–Ω–Ω–æ —Ç–∞–∫, —á–∏—Å—Ç–∞—è –ø—Ä–∞–≤–¥–∞.",
        )


@lru_cache(maxsize=64)
def get_dialog(session_id: str) -> Dialog:
    dialog = Dialog(stopwords=["–∞–ª–∏—Å–∞"])
    api = DialogAPI(dialog)

    stories: list[Story] = [AtTheLessonStory()]

    @api.new_session
    def _():
        api.say(
            "–ü—Ä–∏–≤–µ—Ç. –° —Ç–æ–±–æ–π —á–∞—Å—Ç–æ –ø—Ä–∏–∫–ª—é—á–∞—é—Ç—Å—è –≤–µ—Å—ë–ª—ã–µ –∏—Å—Ç–æ—Ä–∏–∏? –°–æ –º–Ω–æ–π ‚Äì –ø–æ—Å—Ç–æ—è–Ω–Ω–æ. –•–æ—á–µ—à—å, —Ä–∞—Å—Å–∫–∞–∂—É —Ç–µ–±–µ —á—Ç–æ-–Ω–∏–±—É–¥—å?",
            "–ò—Å—Ç–æ—Ä–∏–π –æ—á–µ–Ω—å –º–Ω–æ–≥–æ –∏ –≤—Å–µ –æ–Ω–∏ ‚Äì —á–∏—Å—Ç–∞—è –ø—Ä–∞–≤–¥–∞. –ù–æ —á—Ç–æ–±—ã –∏—Ö –≤—Å–ø–æ–º–Ω–∏—Ç—å, –º–Ω–µ –Ω—É–∂–Ω–∞ —Ç–≤–æ—è –ø–æ–º–æ—â—å.",
            "–Ø –±—É–¥—É –∑–∞–¥–∞–≤–∞—Ç—å —Ç–µ–±–µ –≤–æ–ø—Ä–æ—Å—ã. –¢–≤–æ–∏ –æ—Ç–≤–µ—Ç—ã –ø–æ–º–æ–≥—É—Ç –º–Ω–µ –≤—Å–ø–æ–º–Ω–∏—Ç—å —á—Ç–æ-—Ç–æ –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ–µ. –ù–∞—á–∏–Ω–∞–µ–º?",
        )

        # üî• button

        @api.otherwise
        def _():
            story = stories[0]
            story.tell_story(api)

    return dialog


"""
–û–¥–Ω–∞–∂–¥—ã –≤ –ø–æ–ª–Ω–æ—á—å –≤ –∑–æ–æ–ø–∞—Ä–∫ —Ä–µ—à–∏–ª–∏ –Ω–∞–≤–µ–¥–∞—Ç—å—Å—è —Ç—Ä–æ–µ –¥—Ä—É–∑–µ–π - –í–∞—Å—è, –ü–µ—Ç—è –∏ –ú–∏—à–∞. –û–Ω–∏ –∑–∞–±—Ä–∞–ª–∏—Å—å —á–µ—Ä–µ–∑ –∑–∞–±–æ—Ä, —á—Ç–æ–±—ã –ø–æ–æ–±—â–∞—Ç—å—Å—è —Å –∂–∏–≤–æ—Ç–Ω—ã–º–∏, –∫–æ–≥–¥–∞ –≤—Å–µ —Ä–∞–±–æ—Ç–Ω–∏–∫–∏ —É–∂–µ —É—à–ª–∏.

–í–Ω–µ–∑–∞–ø–Ω–æ, –∏–∑ –Ω–∏–æ—Ç–∫—É–¥–∞ –ø–æ—è–≤–∏–ª–∞—Å—å —Å–º–æ—Ç—Ä–∏—Ç–µ–ª—å–Ω–∏—Ü–∞ –∑–æ–æ–ø–∞—Ä–∫–∞ - —Å—Ç—Ä–∞—à–Ω–∞—è —Å—Ç–∞—Ä—É—Ö–∞ —Å –∫–æ—Å–æ–π.

–î—Ä—É–∑—å—è –≤ —É–∂–∞—Å–µ —Å–µ–ª–∏ –Ω–∞ –ø–µ—Ä–≤—É—é –ø–æ–ø–∞–≤—à—É—é—Å—è —Å–∫–∞–º–µ–π–∫—É –∏ —Ç—É—Ç –∂–µ –ø—Ä–∏—Ç–≤–æ—Ä–∏–ª–∏—Å—å —Å—Ç–∞—Ç—É—è–º–∏, –Ω–∞–¥–µ—è—Å—å, —á—Ç–æ —Å–º–æ—Ç—Ä–∏—Ç–µ–ª—å–Ω–∏—Ü–∞ –∏—Ö –Ω–µ –∑–∞–º–µ—Ç–∏—Ç.

–°—Ç–∞—Ä—É—Ö–∞ –º–µ–¥–ª–µ–Ω–Ω–æ –∏–¥–µ—Ç –≤ –∏—Ö —Å—Ç–æ—Ä–æ–Ω—É, –æ—Å–º–∞—Ç—Ä–∏–≤–∞—è –ø—É—Å—Ç—É—é—â–∏–π –∑–æ–æ–ø–∞—Ä–∫. –ü–æ–¥–æ–π–¥—è –±–ª–∏–∂–µ, –æ–Ω–∞ –≥–ª—è–¥–∏—Ç –Ω–∞ "—Å—Ç–∞—Ç—É–∏" –∏ –∫—Ä–∏—á–∏—Ç: "–ê–≥–∞, —è –≤–∞—Å —Ä–∞–∑–æ–±–ª–∞—á—É!"

–û–Ω–∞ –ø–æ–¥—Ö–æ–¥–∏—Ç –∫ –í–∞—Å–µ –∏ —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç: "–¢—ã —Å—Ç–∞—Ç—É—è?"
–í–∞—Å—è –Ω–µ –º–æ—Ä–≥–∞—è –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ —Å–∫–æ—Ä—É—é —Ä—É–∫—É:
- –Ω–µ—Ç, —è –Ω–æ—Å–æ—Ä–æ–≥ –¥–∞–∂–µ –µ—Å–ª–∏ —è –∏ –Ω–µ –¥–≤–∏–≥–∞—é—Å—å

–°–º–æ—Ç—Ä–∏—Ç–µ–ª—å–Ω–∏—Ü–∞ —Ö–º—É—Ä–æ –∫–∏–≤–∞–µ—Ç –∏ –∏–¥–µ—Ç –∫ –ü–µ—Ç–µ:
- –ê —Ç—ã —Å—Ç–∞—Ç—É—è?
–ü–µ—Ç—è –æ—Ç–≤–µ—Ç–∏–ª –≤ —Ç–æ–Ω:
- –ù–µ—Ç, —è —Ä–∞–≤–Ω–æ–¥—É—à–Ω—ã–π –ª–µ–æ–ø–∞—Ä–¥, –∏ –¥–∞–∂–µ –µ—Å–ª–∏ —è –∏ –Ω–µ –¥–≤–∏–≥–∞—é—Å—å, —ç—Ç–æ –∑–Ω–∞—á–∏—Ç, —á—Ç–æ —è –Ω–µ –µ–º.

–°–º–æ—Ç—Ä–∏—Ç–µ–ª—å–Ω–∏—Ü–∞ –Ω–∞ –º–∏–Ω—É—Ç—É –∑–∞–¥—É–º–∞–ª–∞—Å—å, –ø–æ—á–µ—Å–∞–ª–∞ –∫–æ—Å–æ–π –ø–æ –¥–µ—Ä–µ–≤—É, –∞ –∑–∞—Ç–µ–º –∏–¥–µ—Ç –∫ –ú–∏—à–µ –∏ —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç:
- –¢–∞–∫ –∏ —Ç—ã, –Ω–∞–≤–µ—Ä–Ω–æ–µ, —Ç–æ–∂–µ –Ω–µ —Å—Ç–∞—Ç—É—è?

–ú–∏—à–∞ –æ—Ç–≤–µ—á–∞–µ—Ç:
- –Ø, –ø—Ä–∞–≤–¥–∞, —Å—Ç–∞—Ç—É—è! –ù–æ –¥–æ —Å–∏—Ö –ø–æ—Ä –º–æ–≥ –Ω–∞–ø—É–≥–∞—Ç—å –≤–∞—Å —Å–≤–æ–∏–º –≥–∏–ø—Å–∞–∫–æ–º, –∫–æ–≥–¥–∞ –º–æ–∏ –¥—Ä—É–∑—å—è —É–∂–µ –æ—Ç–≤–µ—Ä–≥–∞–ª–∏ –≤–∞—Å.

–°–º–æ—Ç—Ä–∏—Ç–µ–ª—å–Ω–∏—Ü–∞ –≤—ã–¥–∞–ª–∞ –ª–∞—é—â–∏–π —Å–º–µ—Ö –∏ –∑–ª–æ—Å—Ç–Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∞–ª–∞ –ø–æ–∏—Å–∫ –≤–æ—Ä–∏—à–µ–∫. –ò —Ö–æ—Ç—è –¥—Ä—É–∑—å—è –≤—Å—Ç—Ä–µ—Ç–∏–ª–∏—Å—å —Å –ø—Ä–µ–≤—Ä–∞—Ç–Ω–æ—Å—Ç—è–º–∏ –∏ –æ–±–ª–∞–¥–∞–ª–∏ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–º–∏ –æ–ø—Ä–∞–≤–¥–∞–Ω–∏—è–º–∏, —Ä–µ—à–µ–Ω–∏–µ –ø—Ä–æ–≤–µ—Å—Ç–∏ –Ω–æ—á—å –Ω–∞ —Å–≤–æ–±–æ–¥–µ –±—ã–ª–æ –∂–∏–∑–Ω—å—é —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ. 

–ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ —Å–ª—É—á–∞—è —Å—Ç—Ä–∞—Ö –ø–æ–≤—Å—Ç—Ä–µ—á–∞—Ç—å —Å–º–æ—Ç—Ä–∏—Ç–µ–ª—å–Ω–∏—Ü—É –≤ –ø–æ–ª–Ω–æ—á—å –∑–∞—Å—Ç–∞–≤–∏–ª –∏—Ö –≥–ª—É–±–æ–∫–æ –ø–µ—Ä–µ–æ—Å–º—ã—Å–ª–∏—Ç—å –∏–¥–µ—é –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è –Ω–µ–ø—Ä–µ–¥—É–º—ã—à–ª–µ–Ω–Ω—ã—Ö –Ω–æ—á–Ω—ã—Ö –ø—Ä–æ–≥—É–ª–æ–∫ –≤ –∑–æ–æ–ø–∞—Ä–∫–µ.


Context: [ p:2369 c:706 t:3075 ]

¬© ChatGPT-4.0

–û–¥–Ω–∞–∂–¥—ã, –¥–≤–∞ –¥—Ä—É–≥–∞, –í–∞—Å—è –∏ –ü–µ—Ç—è, —Å–ø–æ—Ä–∏–ª–∏ –æ —Ç–æ–º, –∫—Ç–æ –±—ã—Å—Ç—Ä–µ–µ –ø—Ä–æ–±–µ–∂–∏—Ç 100 –º–µ—Ç—Ä–æ–≤. –ò —Ç—É—Ç –∫ –Ω–∏–º –ø–æ–¥—Ö–æ–¥–∏—Ç —Ç—Ä–µ—Ç–∏–π –ø–∞—Ä–µ–Ω—å, –°–µ—Ä–≥–µ–π, —Ä–µ—à–∞—è –ø–æ—É—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å –≤ —Å–ø–æ—Ä–µ.

- –Ø –∫—Å—Ç–∞—Ç–∏ –ø—Ä–æ–±–µ–≥—É 100 –º–µ—Ç—Ä–æ–≤ –∑–∞ 5 —Å–µ–∫—É–Ω–¥! - –∑–∞—è–≤–∏–ª –°–µ—Ä–≥–µ–π.

–í–∞—Å—è –∏ –ü–µ—Ç—è –±—ã–ª–∏ —à–æ–∫–∏—Ä–æ–≤–∞–Ω—ã –∏ –ø–æ—Å–º–æ—Ç—Ä–µ–ª–∏ –¥—Ä—É–≥ –Ω–∞ –¥—Ä—É–≥–∞ —Å –Ω–µ–¥–æ–≤–µ—Ä–∏–µ–º.

- –¢—ã —á—Ç–æ, —á–µ–ª–æ–≤–µ–∫-–ø–∞—É–∫? - —É—Å–º–µ—Ö–Ω—É–ª—Å—è –í–∞—Å—è.

- –î–∞ –Ω–µ—Ç, - –æ—Ç–≤–µ—Ç–∏–ª –°–µ—Ä–≥–µ–π, - –Ω–æ —É–≤–µ—Ä–µ–Ω, —á—Ç–æ —Å–º–æ–≥—É —ç—Ç–æ —Å–¥–µ–ª–∞—Ç—å —É—Å—Ç–∞–º–∏!

–¢–µ–ø–µ—Ä—å –í–∞—Å—è –∏ –ü–µ—Ç—è –æ—Å—Ç–æ–ª–±–µ–Ω–µ–ª–∏ –æ—Ç —Ç–∞–∫–æ–≥–æ –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏–≤–æ–≥–æ —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∏ —Ä–µ—à–∏–ª–∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, –∫–∞–∫ –∂–µ –°–µ—Ä–≥–µ–π –ø—Ä–æ–±–µ–∂–∏—Ç —Ç–∞–∫–æ–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ —É—Å—Ç–∞–º–∏.

–ò –≤–æ—Ç –æ–Ω–∏ –≤—Å–µ —Ç—Ä–æ–µ —Å—Ç–æ–∏—Ç —É –Ω–∞—á–∞–ª—å–Ω–æ–π –ª–∏–Ω–∏–∏, –í–∞—Å—è –¥–∞—ë—Ç –∫–æ–º–∞–Ω–¥—É: 

- –ù–∞ —Å—Ç–∞—Ä—Ç, –≤–Ω–∏–º–∞–Ω–∏–µ, –º–∞—Ä—à! 

–í—Å—è —Ç—Ä–æ–π–∫–∞ —Å—Ä–∞–∑—É –ø—É—Å–∫–∞–µ—Ç—Å—è –≤ –ø—É—Ç—å, –Ω–æ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥ –°–µ—Ä–≥–µ–π –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è, –æ–±–æ—Ä–∞—á–∏–≤–∞–µ—Ç—Å—è –∏ –≥–æ–≤–æ—Ä–∏—Ç:

- –í–æ—Ç, –ø—Ä–æ–±–µ–∂–∞–ª, –Ω–µ –∑–∞–¥—É–º—ã–≤–∞—è—Å—å –¥–∞–∂–µ –Ω–∞ —Å–µ–∫—É–Ω–¥–æ—á–∫—É!

–í–∞—Å—è —Å –ü–µ—Ç–µ–π —Å–ø–æ—Ç—ã–∫–∞—é—Ç—Å—è –æ–± —Å–≤–æ–∏ –Ω–æ–≥–∏ –∏ –ø–∞–¥–∞—é—Ç —Å–æ —Å–º–µ—Ö—É –Ω–∞ —Ç—Ä–∞–≤—É. –°–µ—Ä–≥–µ–π —Ç–∏—Ö–æ —É–ª—ã–±–∞–µ—Ç—Å—è –∏ —Å–º–æ—Ç—Ä–∏—Ç –Ω–∞ —Å–≤–æ–∏—Ö –¥—Ä—É–∑–µ–π, –∑–∞–¥—É–º–∞–≤—à–∏—Å—å –æ —Å–ª–µ–¥—É—é—â–µ–º –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏–≤–æ–º —Å–ø–æ—Ä–µ.

Context: [ p:31 c:465 t:496 ]

¬© ChatGPT-4.0


1. –ò–∑–≤–∏–Ω–∏, –æ—Ç–≤–ª–µ–∫—Å—è, –ø–æ–≤—Ç–æ—Ä–∏—à—å?
2. –ü—Ä–æ—à—É –ø—Ä–æ—â–µ–Ω–∏—è, –Ω–µ —Ä–∞—Å—Å–ª—ã—à–∞–ª. –°–∫–∞–∂–∏ –µ—â–µ —Ä–∞–∑?
3. –û–π, –∑–∞–¥—É–º–∞–ª—Å—è, –ø–æ–≤—Ç–æ—Ä–∏, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞?
4. –ò–∑–≤–∏–Ω–∏, –Ω–µ —É–ª–æ–≤–∏–ª, –µ—â–µ —Ä–∞–∑, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞?
5. –ü—Ä–æ—Å—Ç–∏, –ø—Ä–æ–ø—É—Å—Ç–∏–ª, —á—Ç–æ —Å–∫–∞–∑–∞–ª?
6. –ù–µ —Å–ª—ã—à–∞–ª, –º–æ–≥ –±—ã –ø–æ–≤—Ç–æ—Ä–∏—Ç—å?
7. –û–ø—è—Ç—å, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–≤–ª–µ–∫—Å—è.

Context: [ p:1989 c:145 t:2134 ]

¬© ChatGPT-4.0
"""
